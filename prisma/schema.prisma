generator client {
    provider = "prisma-client-js"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Door {
    id              String  @id @default(cuid())
    name            String
    description     String?
    size            String
    opening         Opening
    color           String
    innerPanelColor String
    count           Int     @default(0)
    uplotnitel      String?
    zamki           String?
    protivosem      Boolean @default(true)
    vneshPanel      String?
    clouseBox       Boolean @default(false)
    porog           Boolean @default(false)
    inner           String?
    sizesDoor       String?

    @@map("Двери")
}

model BetweenDoor {
    id           String  @id @default(cuid())
    name         String
    factory      String?
    is600        Int     @default(0)
    is700        Int     @default(0)
    is800        Int     @default(0)
    is900        Int     @default(0)
    analog       String?
    colors       String?
    innerFilling String?
    comment      String?
    fotoUrl      String?
    materials    String?
}

model Color {
    id   String  @id @default(cuid())
    name String
    url  String?
}

model Record {
    id          String   @id @default(cuid())
    title       String
    description String?
    quantity    Int      @default(0)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@map("Records")
}

model Price {
    id    String @id @default(cuid())
    name  String
    price String
}

enum Opening {
    LEFT
    RIGHT
}

model User {
    id       String  @id @default(cuid())
    name     String
    email    String  @unique
    phone    String?
    password String
    role     Role    @default(USER)
    nickName String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([role]) // для поиска по роли
    @@index([email, role])
}

enum Role {
    GOOD
    USER
}

model OrderInStock {
    id               String             @id @default(cuid())
    numberOrder      String
    shortDescription String?
    fullDescription  String?
    url              String[]           @default([])
    completed        Boolean            @default(false)
    statusInStock    StatusOrderInStock @default(ORDERED)
}

enum StatusOrderInStock {
    ORDERED
    IN_STOCK
    DELIVERY_PROCESS
    DELIVERED
}

model OrderBN {
    id          String  @id @default(cuid())
    name        String
    orderNumber String?
    in1C        Boolean @default(false)
}

model verifyCode {
    id       String  @id @default(cuid())
    email    String
    code     String
    attempts Int     @default(0) // счётчик попыток
    used     Boolean @default(false) // был ли использован

    createdAt    DateTime  @default(now())
    expiresAt    DateTime // срок действия
    blockedUntil DateTime? //блокировка после неудачных попыток

    @@index([email, createdAt]) // для поиска и сортировки
    @@index([expiresAt]) // для проверки срока действия
    @@index([used]) // для очистки использованных кодов
    @@index([blockedUntil]) // для проверки блокировки
    @@index([email, expiresAt, used]) // Составной для активных кодов
}

//Таблица ip и заблокированных ip
model IpRateLimit {
    id             String   @id @default(cuid())
    ip             String
    action         String // "verify_code", "login_attempt", "admin_verify"
    count          Int      @default(1)
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    manual_locking Boolean  @default(false)
    // client_name    String   @default("Не известный") //РАЗОБРАТЬСЯ С БД

    @@unique([ip, action], name: "ip_action")
    // быстрый поиск
    @@index([ip, action, createdAt], name: "ip_action_time")
    @@index([createdAt], name: "created_at_idx")
    @@index([manual_locking])
}
